> См. также: [API](API_METHODS.md), [Схема БД](DATABASE_SCHEMA.md), [Роли пользователя](USER_ROLES.md)

# Техническое задание: Backend/API CabrioRide

## 1. Общие положения
- Backend реализован на PHP 8.1 (PSR-12).
- RESTful API архитектура.
- JWT для безопасности API.
- Взаимодействие с MySQL 8.0 через модели.
- Apache (XAMPP для разработки).

## 2. Архитектура и структура
- REST API endpoints в snake_case.
- Документировать все API методы.
- Валидация входных данных.
- Модели для работы с БД (ORM/ActiveRecord-подход).
- Бизнес-логика вынесена в сервисы.
- Вспомогательные функции — в utils.

## 3. Структура backend-проекта
```
backend/
├── api/           # REST API endpoints
│   ├── auth/      # Авторизация
│   ├── users/   # Работа с участниками
│   ├── cars/      # Работа с автомобилями
│   └── events/    # Работа с мероприятиями
├── config/        # Конфигурации
│   ├── database.php
│   ├── telegram.php
│   └── app.php
├── models/        # Модели для работы с БД
├── services/      # Бизнес-логика
├── utils/         # Вспомогательные функции
└── uploads/       # Загружаемые файлы
```

## 4. Требования к коду
- PSR-12 для форматирования PHP
- Документировать API методы
- Валидация входных данных
- Строгое разделение бизнес-логики и контроллеров
- Не допускать прямых запросов к БД без моделей
- Логирование всех действий
- Обработка ошибок

## 5. Безопасность
- JWT для авторизации API
- Проверка Telegram-данных
- Шифрование и защита данных
- Внешние ключи обязательны в БД
- Индексировать поля поиска

## 6. Проверки и валидация
- Корректность API-ответов
- Валидация данных
- Загрузка файлов
- Права доступа
- Логирование действий

## 7. Деплой
- Проверка конфигурации
- Обновление API и бота
- Проверка интеграции с Telegram
- Разные .env для разработки и прода
- Проверка прав на папки
- Backup базы данных

## 8. Примечания
- Все изменения должны быть задокументированы
- Строгое следование стандартам проекта 

---

### API: /api/ocr — распознавание номера по фото

- Backend принимает POST multipart/form-data с файлом изображения (до 3 МБ)
- Выполняет ресайз/валидацию изображения (опционально)
- Отправляет изображение на внешний сервис platerecognizer.com (токен из .env)
- Получает JSON-ответ, извлекает номер с максимальной уверенностью
- Ищет этот номер в базе данных клуба (таблица cars, поле reg_number)
- Если найдено совпадение:
  - Возвращает статус авто (active, pending, blocked и т.д.)
- Если не найдено:
  - Возвращает found: false
- В ответе всегда возвращается исходный raw-ответ platerecognizer.com для отладки
- Обработка ошибок: неверный формат, слишком большой файл, ошибка внешнего API, отсутствие номера и т.д.
- Эндпоинт используется как для WebApp, так и для Telegram-бота 

---

### Полный путь работы системы распознавания номеров (от пользователя до ответа)

1. Пользователь (например, в Telegram-боте) отправляет фотографию автомобиля.
2. Бот получает фото и отправляет его POST-запросом на backend-эндпоинт /api/ocr (multipart/form-data).
3. Backend принимает файл, проверяет размер и формат, при необходимости ресайзит.
4. Backend отправляет изображение на внешний сервис platerecognizer.com (токен из .env).
5. Получает JSON-ответ с распознанными номерами, регионом, уверенностью и т.д.
6. Backend извлекает основной номер, ищет его в базе (cars.reg_number, точное совпадение).
7. Если номер найден — определяет статус авто (active, pending, blocked и т.д.), если не найден — отмечает это.
8. Backend возвращает боту JSON: распознанный номер, регион, уверенность, статус в клубе, raw-ответ platerecognizer.com.
9. Бот получает ответ, анализирует его и формирует сообщение пользователю:
   - Если номер найден: «Распознан номер: 0070MX7. Такой номер есть в клубе, статус авто: active.»
   - Если не найден: «Распознан номер: 0070MX7. Такого номера нет в клубе.»
   - Если ошибка — сообщает об ошибке.
10. Пользователь получает результат в чате.

Кратко (схема):
Пользователь → (фото) → Бот → (фото) → Backend (/api/ocr) → (фото) → platerecognizer.com → (JSON) → Backend → (поиск в БД) → Backend → (JSON) → Бот → (текст) → Пользователь 

---

### API: /api/plate-search — поиск автомобиля по номеру (текст)

- Backend принимает POST JSON с полем "query" (номер или его часть)
- Выполняет поиск по базе (таблица cars, поле reg_number, LIKE %query%)
- Возвращает только found: true/false (есть совпадения или нет)
- Не возвращает список номеров, статусы, регионы и т.д.
- Используется ботом для поиска по тексту
- Обработка ошибок: пустой запрос, слишком короткий запрос, некорректные символы и т.д. 
