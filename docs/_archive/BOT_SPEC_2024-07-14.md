> См. также: [Техническое задание](TECHNICAL_SPECIFICATION.md), [Роли и статусы](USER_ROLES_STATUSES.md), [Пользовательские сценарии](USER_FLOWS.md)

# Техническое задание: Telegram-бот Cabrio Club

### 1. Цели и назначение
- Бот — официальный мост между Telegram-группой клуба и WebApp.
- Все функции доступны только участникам Telegram-группы.
- Бот обеспечивает автоматизацию приветствий, уведомлений, авторизации и поиска.

### 2. Основные функции (MVP)

#### 2.1. Приветствие новых участников
- При добавлении нового пользователя в группу бот:
  - Приветствует участника с упоминанием через @username.
  - Отправляет краткую инструкцию по использованию бота и клуба.
- В момент вступления бот сохраняет в БД все доступные данные пользователя:
  - `telegram_id` — ID пользователя в Telegram
  - `username` — Username из Telegram
  - `first_name` — Имя
  - `last_name` — Фамилия
  - `photo_url` — URL аватара (если есть)
  - `language_code` — Язык (если доступно)
  - `auth_date` — Дата авторизации/вступления
  - другие поля, если предусмотрены в БД

#### 2.2. Проверка членства и статусов
- При вступлении создаётся запись в БД:
  - В таблице `users` сохраняются все данные пользователя, включая Telegram-данные:
    - `telegram_id`, `username`, `first_name`, `last_name`, `photo_url`, `language_code`, `auth_date` и др.
    - `join_date` — дата вступления
    - `status: "Новый"`
    - `role: "Гость"`
- При выходе из группы:
  - Статус пользователя меняется на "вышел"
  - Бот перестаёт работать с этим пользователем
  - В группу отправляется уведомление о выходе участника

#### 2.3. Уведомления о событиях
- Бот отправляет в группу сообщения о важных изменениях:
  - Регистрация нового участника в приложении
  - Добавление автомобиля
  - Другие события (расширяемо)
- Список типов уведомлений и их активность настраиваются через конфиг-файл (например, JSON/PHP-массив с true/false)

#### 2.4. Авторизация в WebApp
- Вход в WebApp возможен только через кнопку в боте (Telegram WebApp)
- Если пользователь пытается зайти напрямую, он видит информационный блок с инструкцией о необходимости вступить в клуб

#### 2.5. Поиск автомобиля в чате
- Поиск осуществляется через обращение к боту:
  - В чате пишут: `@bot <номер_авто>`
  - Бот ищет авто по номеру и отвечает в чате (ответ виден всем)
- Поиск доступен только участникам группы

### 3. Технические требования
- Язык: PHP (webhook-архитектура, без постоянного процесса)
- Интеграция: Webhook от Telegram направлен на endpoint бота (например, `bot/webhook.php`)
- Взаимодействие с БД: Все действия по членству, статусам, событиям и поиску фиксируются в базе данных
- Безопасность:
  - Бот работает только с участниками группы
  - Проверка членства обязательна при каждом взаимодействии
- Логирование:
  - Все ключевые действия и события логируются для аудита

### 4. Структура БД и сохраняемые поля

> ⚠️ Важно! С июля 2025 года используется новая структура базы данных. Актуальная схема и описание всех таблиц — в docs/DATABASE_SCHEMA.md. Все старые описания и таблицы (user_auth, member и др.) удалены как неактуальные.

### 5. Расширения (на перспективу)
- Управление уведомлениями через команды для админов
- Поиск авто по номеру в личке бота
- Интеграция с дополнительными сервисами клуба
- Расширение набора уведомлений и команд

### 6. Примечания
- Если пользователь не состоит в группе, бот сообщает, что работать не будет, и предлагает вступить
- Все данные, которые Telegram предоставляет о пользователе, сохраняются в БД (если предусмотрено структурой)
- Структура БД должна быть согласована с backend-разработкой 

---

### Распознавание номера по фото (интеграция с API)

- Пользователь отправляет фото автомобиля боту
- Бот отправляет фото на backend-эндпоинт /api/ocr
- Получает распознанный номер и информацию о статусе авто в клубе
- Бот отвечает:
  - "Распознан номер: 0070MX7. Такой номер есть в клубе, статус авто: active.
  - или "Распознан номер: 0070MX7. Такого номера нет в клубе."
- Если номер не распознан или фото невалидно — бот сообщает об ошибке 

---

### Поиск по номеру (текстовый запрос)

- Пользователь отправляет номер автомобиля текстом (например, в чат бота)
- Бот отправляет запрос на backend-эндпоинт /api/plate-search с этим номером
- Получает found: true/false
- Бот отвечает:
  - "В клубе есть авто с таким номером."
  - или "В клубе нет авто с таким номером."
- Если запрос некорректный — бот сообщает об ошибке 