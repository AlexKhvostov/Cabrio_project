# 13. Выход из клуба и блокировка

## 1. Название сценария
Выход из клуба и блокировка

## 2. Цель сценария
Обеспечить корректную обработку выхода пользователя из клубного Telegram-чата или его блокировки, с сохранением истории и безопасным ограничением доступа к приложению.

## 3. Участники и роли
- Пользователь (member, registered, guest)
- Модератор/админ (может удалить пользователя из чата)
- Telegram-бот
- Backend приложения

## 4. Предусловия
- Пользователь зарегистрирован в Telegram
- Пользователь был активен в приложении и состоял в клубном чате

## 5. Основной поток (пошагово)
1. Пользователь вручную покидает клубный Telegram-чат или его удаляет модератор/админ.
2. При любой активности в приложении backend проверяет членство в чате через Telegram API.
3. Если пользователь больше не состоит в чате:
   - Роль пользователя меняется на external.
   - Пользователь теряет доступ ко всем разделам приложения.
   - На экране появляется заглушка с объяснением и ссылкой на чат.
4. Если пользователь снова вступает в чат, при следующей проверке роль обновляется:
   - Если у пользователя есть авто/главный гость — роль registered.
   - Если нет — роль guest.
5. Все данные пользователя и связанные сущности (авто, отзывы, события) сохраняются в базе для истории и аудита.

## 6. Альтернативные потоки / Edge-cases
- Если пользователь был удалён из чата модератором — причина фиксируется в логах модерации.
- Если пользователь пытается войти с тем же Telegram-аккаунтом — видит заглушку с объяснением.
- Если Telegram API временно недоступен — показывается сообщение об ошибке.
- Если пользователь возвращается в чат — роль становится guest или registered, доступ восстанавливается.

## 7. Роли пользователя и переходы

> В этом разделе описаны только роли пользователя (см. docs/USER_ROLES.md)
- member/registered/guest → external (при выходе из чата)
- external → guest/registered (при возвращении в чат)
- Все автомобили пользователя получают статус "external_car" и скрываются из публичных разделов при external (см. схему статусов авто).

## 8. UX-детали
- Заглушка с объяснением и ссылкой на чат
- Проверка членства происходит автоматически
- После возвращения в чат доступ восстанавливается без лишних действий

## 9. Интеграции и API
- Telegram Bot API
- Проверка членства через Telegram API
- Backend: смена роли пользователя и связанных сущностей
- Логи модерации

## 10. Уведомления
- Личные уведомления о смене роли (external)
- Сообщения об ошибках (недоступен Telegram API)
- Причина удаления фиксируется в логах (если применимо)

## 11. Ограничения и лимиты
- Доступ к приложению только для участников чата (роль не external)
- Все данные сохраняются для истории и аудита
- Нет возможности удалить профиль полностью через интерфейс

## 12. Связанные сценарии и документы
- [Авторизация и вход через Telegram](12_authorization.md)
- [Работа с Telegram-ботом](11_telegram_bot.md)
- [Роли пользователя](../USER_ROLES.md)

## 13. Тест-кейсы (минимум 3)
- Пользователь выходит из чата — роль меняется на external, доступ блокируется, появляется заглушка
- Пользователь возвращается в чат — роль становится guest или registered, доступ восстанавливается
- Модератор удаляет пользователя из чата, причина фиксируется в логах 

> Для пользователя применяются только роли из docs/USER_ROLES.md 