# 11. Работа с Telegram-ботом

> **Пояснение:** Пользователь, не завершивший регистрацию — это пользователь с ролью "new" или "external". Запись о таком пользователе создаётся в базе при первом обращении к боту, но он ещё не прошёл все этапы регистрации. Только пользователи с ролью, отличной от "new" и "external", считаются завершившими регистрацию и получают доступ к основному функционалу.

## 1. Название сценария
Работа с Telegram-ботом (авторизация, проверки, уведомления, интеграция с WebApp)

## 2. Цель сценария
Обеспечить безопасную авторизацию, интеграцию с WebApp, проверку членства в чате, отправку уведомлений и дополнительные сервисные функции через Telegram-бота CabrioRide.

## 3. Участники и роли
- Пользователь (член клуба)
- Telegram-бот
- Админ/модератор (опционально)

## 4. Предусловия
- Пользователь зарегистрирован в Telegram
- Пользователь состоит в клубном Telegram-чате

## 5. Основной поток (пошагово)
1. Пользователь отправляет команду /start боту.
2. Бот проверяет членство в клубном чате:
   - Если не состоит — отправляет заглушку с инструкцией вступить в чат.
   - Если состоит — проверяет, завершил ли пользователь регистрацию в приложении:
     - Если не завершил регистрацию (роль "new" или "external") — отправляет приветствие и кнопку «Зарегистрироваться» (deep-link в WebApp на страницу регистрации).
     - Если завершил регистрацию — отправляет стандартное приветствие и кнопку «Перейти в приложение» (deep-link в WebApp).
3. Пользователь нажимает на соответствующую кнопку:
   - «Зарегистрироваться» — открывается WebApp на странице регистрации, данные Telegram передаются в приложение.
   - «Перейти в приложение» — открывается WebApp на главной, данные Telegram передаются в приложение.
4. В WebApp повторно проверяется членство в чате, при отсутствии — заглушка.
5. Пользователь может отправить боту фото автомобиля для распознавания номера:
   - Если номер найден — бот сообщает статус, предлагает оставить визитку (если пользователь active).
   - Если не найден — просто сообщает результат.
6. Пользователь может отправить номер автомобиля текстом для поиска совпадений.
7. Все действия сопровождаются уведомлениями и подсказками.

## 6. Альтернативные потоки / Edge-cases
- Если Telegram API недоступен — показывается сообщение об ошибке.
- Если пользователь не состоит в чате — все функции недоступны, всегда заглушка.
- Если пользователь не завершил регистрацию — доступна только кнопка «Зарегистрироваться» (deep-link в WebApp), остальные функции недоступны.
- Если роль пользователя не member или выше — бот не предлагает оставить визитку.
- Если фото не удалось распознать — сообщение об ошибке, возможность попробовать снова или ввести вручную.
- Если превышен лимит проверок/визиток — соответствующее сообщение.

## 7. Роли пользователя и переходы

> В этом разделе описаны только роли пользователя (см. docs/USER_ROLES.md)
- Пользователь: external, guest, new, registered, member, moderator, admin (см. docs/USER_ROLES.md). Для некоторых функций может использоваться дополнительная проверка членства в чате.
- Визитка: создана/не создана

## 8. UX-детали
- Все сообщения и инструкции берутся из конфига bot.notifications
- Кнопка «Зарегистрироваться» показывается только пользователям, не завершившим регистрацию (статус "new" или "external") (deep-link на регистрацию в WebApp)
- Кнопка «Перейти в приложение» — только для пользователей, завершивших регистрацию и состоящих в чате
- Проверка авто по фото — только для участников чата, сразу после распознавания спрашивается про визитку
- Проверка авто по номеру — только поиск, без визитки
- Заглушка с объяснением и ссылкой на чат при отсутствии членства

## 9. Интеграции и API
- Telegram Bot API
- Проверка членства через Telegram API
- Интеграция с WebApp (deep-link, передача user_id, username и др.)
- API для распознавания номера (/api/ocr, /api/plate-search)
- Конфиги: bot.config.ts, app.config.ts

## 10. Уведомления
- Личные уведомления пользователю (бот в личку):
  - регистрация (шаблон для новых пользователей: приветствие и кнопка «Зарегистрироваться»)
  - модерация, авто, события, отзывы, respect, визитки, ошибки, лимиты, системные
- Групповые уведомления (бот в чат клуба): приветствие новых участников, новые авто, события, гид-объекты, визитки
- Все шаблоны уведомлений и их включение/выключение настраиваются в bot.config.ts

## 11. Ограничения и лимиты
- Все лимиты (проверки, визитки) — в app.config.ts
- Только для пользователей, состоящих в клубном чате
- Проверка членства обязательна на каждом этапе

## 12. Связанные сценарии и документы
- [Визитки и приглашения](05_business_card.md)
- [Авторизация и вход через Telegram](12_authorization.md)
- [Конфиг уведомлений бота](../config/bot.config.ts)
- [API: /api/ocr, /api/plate-search](../API_METHODS.md)

## 13. Тест-кейсы (минимум 3)
- Пользователь не состоит в чате — бот отправляет заглушку, функции недоступны
- Пользователь отправляет фото авто, бот распознаёт номер и предлагает оставить визитку
- Пользователь переходит в WebApp через deep-link, данные Telegram успешно передаются 