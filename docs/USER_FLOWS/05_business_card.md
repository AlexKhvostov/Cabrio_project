# Визитки и приглашения

## 1. Название сценария
Визитки и приглашения (оставление визитки через приложение)

## 2. Цель сценария
Позволить активному участнику клуба пригласить нового пользователя, оставив визитку на автомобиле, который не найден в базе CabrioRide, через удобный и прозрачный процесс с учётом лимитов и проверки статусов.

## 3. Участники и роли
- Пользователь с ролью member или выше (оставляет визитку)
- Новый потенциальный участник (получатель визитки)
- Backend
- Telegram-бот

## 4. Предусловия
- Пользователь авторизован, имеет роль member или выше и доступ к функции визиток.

## 5. Основной поток (пошагово)
1. Пользователь открывает функцию "Проверить авто / визитки" на дашборде.
2. Выбирает способ поиска:
   - Загрузить фото автомобиля (распознавание номера)
   - Ввести номер автомобиля (только латиница и цифры, минимум 3 символа)
3. Система проверяет наличие авто в базе:
   - **Фото:**
     - Если номер не распознан — выводится ошибка и рекомендация попробовать ещё раз или воспользоваться текстовым поиском.
     - Если номер распознан:
       - Пользователю сначала отображается распознанный номер (например: «Распознан номер: А123ВС77»).
       - Ниже — информация о принадлежности:
         - если авто найдено — статус авто (например: «Этот автомобиль найден в клубе. Статус: активен»);
         - если авто не найдено — сообщение «Такого номера нет в клубе».
       - После этого появляется вопрос: «Хотите оставить визитку?».
   - **Текстовый поиск:**
     - Если введено 3–5 символов:
       - Система ищет все автомобили с частичным совпадением номера.
       - Если есть совпадения — выводится сообщение: «В базе есть автомобили с похожими номерами».
       - Если совпадений нет — сообщение «Совпадений не найдено».
       - Вопрос о визитке не задаётся.
     - Если введено 6+ символов:
       - Система ищет точное совпадение.
         - Если найдено — показывается найденный автомобиль и его статус, затем появляется вопрос: «Хотите оставить визитку?».
         - Если точного совпадения нет, но есть частичные совпадения — сообщение: «В базе есть автомобили с похожими номерами», вопрос о визитке не задаётся.
         - Если нет ни точных, ни частичных совпадений — сообщение: «Такого номера нет в клубе. Пожалуйста, убедитесь, что номер введён полностью и правильно», затем появляется вопрос: «Хотите оставить визитку?». 
4. Если "Да":
   - Если авто найдено — создаётся запись визитки, привязанная к существующей машине.
   - Если авто не найдено — создаётся новая машина (без хозяина) и запись визитки, привязанная к ней.
   - Для отправки визитки номер должен содержать минимум 6 символов.
   - После успешной отправки — сообщение "Визитка зафиксирована!" и возврат на дашборд.
5. Если "Нет" — возврат к поиску авто.

## 6. Альтернативные потоки / Edge-cases
- Если данных недостаточно (не распознан номер, не загружено фото, номер короче 6 символов) — ошибка, просьба повторить попытку.
- Если лимит проверок исчерпан — функция недоступна до следующего дня.
- Если пользователь не активен — функция недоступна.
- Для поиска авто достаточно 3 символов, для отправки визитки — минимум 6 символов.

## 7. Роли и статусы: переходы

> Для пользователя применяются только роли (см. docs/USER_ROLES.md). Для автомобилей используются отдельные статусы (например, 'активен', 'удалён').
- Визитка создаётся только для пользователей с ролью member или выше (см. docs/USER_ROLES.md).
- Авто может быть с любым статусом (например, активен, удалён, вышел из клуба, на модерации и др. — см. схему статусов авто).
- При создании новой машины — статус авто по умолчанию "на модерации" или "внешний" (уточнить при реализации).

## 8. UX-детали
- При частичных совпадениях (3–5 символов или 6+ символов без точного совпадения) выводится только сообщение о наличии похожих номеров, список не показывается.
- Вопрос «Хотите оставить визитку?» появляется только если:
  - найдено точное совпадение (после показа информации об авто);
  - не найдено ни точных, ни частичных совпадений (после сообщения о том, что авто не найдено и просьбы проверить номер).
- Если есть только частичные совпадения — вопрос о визитке не задаётся, пользователь может скорректировать ввод.
- Кнопка "Оставить визитку" активна только при заполнении обязательных полей (фото и номер, номер не короче 6 символов).
- Все лимиты и ошибки отображаются в виде подсказок.

## 9. Интеграции и API
- Backend: поиск авто, создание визитки, создание новой машины
- API: /api/ocr (распознавание номера по фото), /api/plate-search (поиск по номеру)
- Telegram-бот: уведомления о визитках

## 10. Уведомления
- Через Telegram-бота:
  - Визитка успешно оставлена
  - Ошибка при отправке визитки (не хватает данных, превышен лимит)
  - Превышен лимит проверок авто/визиток

## 11. Ограничения и лимиты
- Только для пользователей со статусом "active"
- 6 проверок в сутки (см. config/app.config.ts, 0 = без ограничений)
- Фото и номер — обязательные для визитки
- Для поиска авто — минимум 3 символа, для визитки — минимум 6 символов
- Лимит: см. параметр `invites.maxCarChecksPerDay` в [config/app.config.ts](../../config/app.config.ts)

## 12. Связанные сценарии и документы
- [Регистрация и первый вход](01_registration.md)
- [Схема БД: business_cards, cars](../DATABASE_SCHEMA.md)
- [API: /api/ocr, /api/plate-search](../API_METHODS.md)
- [Уведомления](15_notifications.md)
- [Лимиты и параметры](../config/app.config.ts)

## 13. Тест-кейсы (минимум 3)
- Пользователь успешно оставляет визитку на авто, которого нет в базе, создаётся новая машина и запись визитки, появляется уведомление.
- Пользователь превышает лимит проверок — функция недоступна, появляется соответствующее сообщение.
- При попытке оставить визитку без обязательных данных (фото или номер < 6 символов) — появляется ошибка.

---

> Все шаги и статусы согласованы с бизнес-логикой и схемой БД CabrioRide. UX-детали, лимиты и уведомления должны быть реализованы согласно этому сценарию. 