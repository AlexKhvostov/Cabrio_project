# Голосовые сообщения на карте

## 1. Название сценария
Голосовые сообщения на карте

## 2. Цель сценария
Позволить пользователям быстро обмениваться голосовыми сообщениями в разделе "Карта" для координации, общения и повышения вовлечённости клуба.

## 3. Участники и роли
- Пользователь
- Backend

## 4. Предусловия
- Пользователь авторизован и имеет доступ к разделу "Карта".
- Профиль пользователя не заблокирован.

## 5. Основной поток (пошагово)
1. Пользователь нажимает и удерживает кнопку микрофона на карте.
2. Записывает голосовое сообщение (до 30 сек).
3. Отпускает кнопку — сообщение отправляется на сервер.
4. Все активные на карте получают уведомление и сообщение автоматически воспроизводится (если пользователь не записывает своё сообщение).
5. Если пользователь занят записью, входящие сообщения становятся в очередь и воспроизводятся после завершения записи.
6. Пользователь может открыть список последних сообщений и прослушать любое из них вручную.
7. Сообщения автоматически удаляются через 1 час.

## 6. Альтернативные потоки / Edge-cases
- Если пользователь не дал разрешение на микрофон — появляется уведомление, функция недоступна.
- Если превышена длительность записи — запись автоматически останавливается.
- Если пользователь отключил передачу координат — не может отправлять голосовые сообщения.
- Если у пользователя нет роли member или выше — функция недоступна.
- Ошибка отправки/получения — появляется уведомление.

## 7. Статусы и переходы
- После отправки голосового сообщения оно становится доступно всем активным на карте.
- Сообщения удаляются через 1 час автоматически.

## 8. UX-детали
- Кнопка микрофона всегда доступна на карте (если разрешён микрофон и координаты).
- Визуальный индикатор записи (анимация, таймер).
- Очередь сообщений отображается списком.
- Автоматическое воспроизведение новых сообщений.
- Уведомления о новых сообщениях и ошибках.

## 9. Интеграции и API
- Backend: приём, хранение, удаление голосовых сообщений
- API: /api/map/voice (POST), /api/map/voices (GET)

## 10. Уведомления
- В приложении:
  - Уведомление о новом голосовом сообщении
  - Уведомление об ошибке записи/отправки
  - Уведомление о недоступности функции (нет разрешения на микрофон/координаты)

## 11. Ограничения и лимиты
- Длительность сообщения — до 30 секунд
- Сообщения хранятся не более 1 часа
- Без разрешения на микрофон и координаты функция недоступна
- Лимит: см. параметры `voiceMessages.maxDurationSeconds`, `voiceMessages.maxLifetimeMinutes`, `voiceMessages.maxPerUser` в [config/app.config.ts](../../config/app.config.ts)

## 12. Связанные сценарии и документы
- [Использование раздела "Карта"](07_map.md)
- [Схема БД: голосовые сообщения](../DATABASE_SCHEMA.md) (если реализовано)
- [API: /api/map/voice, /api/map/voices](../API_METHODS.md)

## 13. Тест-кейсы (минимум 3)
- Пользователь записывает и отправляет голосовое сообщение, оно автоматически воспроизводится у других активных на карте.
- Пользователь не дал разрешение на микрофон — функция недоступна, появляется уведомление.
- Сообщение автоматически удаляется через 1 час, исчезает из списка.
- Если пользователь отключил передачу координат — не может отправлять голосовые сообщения.

---

> Все шаги и статусы согласованы с бизнес-логикой и схемой БД CabrioRide. UX-детали, ограничения и уведомления должны быть реализованы согласно этому сценарию. 