# Добавление и управление автомобилями

## 1. Название сценария
Добавление и управление автомобилями

## 2. Цель сценария
Позволить пользователю добавить, редактировать и удалять свои автомобили, поддерживать актуальность информации об авто, а также обеспечить корректное отображение и учёт автомобилей в клубе.

## 3. Участники и роли
- Пользователь
- Backend
- Telegram-бот
- (Модератор — косвенно, при проверке профиля)

## 4. Предусловия
- Пользователь авторизован и имеет доступ к разделу "Авто".
- Профиль пользователя не заблокирован.

## 5. Основной поток (пошагово)
1. Пользователь открывает раздел "Авто" в приложении.
2. В правом нижнем углу отображается плавающая кнопка "+" (FAB) для добавления нового автомобиля.
3. При нажатии на "+" открывается форма добавления авто:
   - Фото автомобиля (обязательное)
   - Марка и модель (выбор из справочника, обязательное)
   - Регистрационный номер (обязательное)
   - Чекбокс "Скрыть номер" (по умолчанию выключен)
4. Пользователь заполняет обязательные поля и нажимает "Сохранить".
5. После успешного добавления:
   - Автомобиль появляется в списке авто пользователя.
   - Если это первый авто, пользователю предлагается заполнить профиль до конца для получения доступа ко всем функциям.
   - Прогресс заполнения профиля пересчитывается (см. [profile_weights.md](profile_weights.md)).
   - Пользователь получает уведомление через Telegram-бот: «Автомобиль успешно добавлен».
6. В списке авто отображаются все автомобили пользователя.
7. При нажатии на автомобиль открывается подробная карточка авто:
   - Доступны кнопки «Редактировать» и «Удалить» (только для своих авто).
   - При редактировании — поля становятся доступны для изменения, после сохранения — уведомление через Telegram-бот.
   - При удалении — авто помечается как 'удалён' (статус автомобиля), запись остаётся в базе.

## 6. Альтернативные потоки / Edge-cases
- Если пользователь был с ролью member и удаляет последний авто — он остаётся member. Автоматического понижения роли не происходит. Понизить роль может только администратор вручную (и только до registered). См. docs/USER_ROLES.md
- Если достигнут лимит по количеству авто — кнопка "+" становится неактивной, появляется подсказка (лимит настраивается в config/app.config.ts).
- Все ошибки и успешные действия сопровождаются уведомлениями через Telegram-бот.
- Если профиль заблокирован — добавление/редактирование/удаление авто недоступно.

## 7. Роли и статусы: переходы

> Для пользователя применяются только роли (см. docs/USER_ROLES.md). Для автомобилей используются отдельные статусы (например, 'удалён').
- При добавлении первого авто: если был new, роль пользователя может измениться на registered (при выборе авто/главного гостя). См. docs/USER_ROLES.md
- Удаление авто — авто помечается как 'удалён', запись остаётся в базе.

## 8. UX-детали
- Кнопка "+" (FAB) всегда видна в правом нижнем углу раздела "Авто".
- Редактирование и удаление доступны только для своих автомобилей и только из подробной карточки.
- После добавления/редактирования/удаления авто пользователь остаётся в разделе "Авто" и видит актуальный список.
- Все поля валидируются в реальном времени.
- Под незаполненными полями — подсказки.

## 9. Интеграции и API
- Backend: добавление, редактирование, удаление авто, пересчёт прогресса профиля
- API для загрузки фото, справочники марок/моделей
- Telegram-бот: уведомления о действиях с авто

## 10. Уведомления
- Через Telegram-бота:
  - Автомобиль успешно добавлен
  - Автомобиль отредактирован
  - Автомобиль удалён (статус 'удалён')
  - Ошибки и лимиты

## 11. Ограничения и лимиты
- Лимит на количество авто на пользователя (см. config/app.config.ts)
- Без обязательных полей нельзя добавить/сохранить авто
- Если профиль заблокирован — управление авто недоступно
- Лимит: см. параметр `events.maxPerUser` в [config/app.config.ts](../../config/app.config.ts)

## 12. Связанные сценарии и документы
- [Регистрация и первый вход](01_registration.md)
- [Редактирование профиля](02_profile_edit.md)
- [Схема развесовки анкеты](profile_weights.md)
- [Схема БД: cars, link_user_cars](../DATABASE_SCHEMA.md)
- [API: /api/cars](../API_METHODS.md)

## 13. Тест-кейсы (минимум 3)
- Пользователь добавляет первый авто, если был new, роль пользователя меняется на registered.
- Пользователь удаляет последний авто, если он был member — он остаётся member. Автоматического понижения роли не происходит.
- При превышении лимита авто кнопка "+" неактивна, появляется подсказка.
- После удаления авто он помечается как 'удалён', но остаётся в базе.

---

> Все шаги и статусы согласованы с бизнес-логикой и схемой БД CabrioRide. UX-детали и уведомления должны быть реализованы согласно этому сценарию. 