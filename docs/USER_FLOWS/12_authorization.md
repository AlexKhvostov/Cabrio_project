# 12. Авторизация и вход через Telegram

## 1. Название сценария
Авторизация и вход через Telegram

## 2. Цель сценария
Обеспечить безопасный и удобный вход в приложение CabrioRide только для участников клубного Telegram-чата, с автоматической проверкой статуса и актуализацией данных.

## 3. Участники и роли
- Пользователь (член клуба)
- Telegram-бот
- Backend приложения

## 4. Предусловия
- Пользователь зарегистрирован в Telegram
- Пользователь состоит в клубном Telegram-чате

## 5. Основной поток (пошагово)
1. Пользователь запускает Telegram-бота CabrioRide.
2. В боте отображается кнопка «Перейти в приложение» (deep-link в WebApp).
3. Приложение получает данные пользователя от Telegram (user_id, username и др.).
4. Backend проверяет, состоит ли пользователь в клубном чате через Telegram API.
5. Если пользователь впервые — создаётся запись в базе.
6. Если пользователь состоит в чате — доступ к приложению открыт, пользователь продолжает путь (user journey).
7. Если пользователь не состоит в чате — статус становится external, показывается заглушка с инструкцией вступить в чат.
8. При любой активности в приложении повторно проверяется членство в чате.

## 6. Альтернативные потоки / Edge-cases
- Если пользователь покидает чат во время работы — при следующей активности роль меняется на external, появляется заглушка.
- Если Telegram API недоступен — показывается сообщение об ошибке.
- Если пользователь возвращается в чат — при следующей проверке статус обновляется, доступ восстанавливается.
- Если WebApp не может получить данные Telegram — показывается сообщение об ошибке.

## 7. Роли пользователя и переходы

> В этом разделе описаны только роли пользователя (см. docs/USER_ROLES.md)
- Пользователь: member/registered/guest/admin/moderator → external (при выходе из чата)
- При возвращении в чат — роль становится guest или registered (по наличию авто/главного гостя)

## 8. UX-детали
- Заглушка с объяснением и ссылкой на чат при отсутствии членства
- Проверка членства происходит автоматически, без лишних действий пользователя
- Кнопка для перехода в чат всегда доступна на заглушке

## 9. Интеграции и API
- Telegram Bot API
- Проверка членства через Telegram API
- Интеграция с WebApp (deep-link, передача user_id, username и др.)
- Backend: создание/обновление пользователя, смена статусов

## 10. Уведомления
- Личные уведомления о смене статуса (external, left, active)
- Сообщения об ошибках (недоступен Telegram API, нет данных Telegram)

## 11. Ограничения и лимиты
- Вход только для участников клубного чата
- Проверка членства обязательна на каждом этапе
- Нет возможности войти без Telegram

## 12. Связанные сценарии и документы
- [Работа с Telegram-ботом](11_telegram_bot.md)
- [Выход из клуба и блокировка](13_club_exit.md)
- [Конфиг уведомлений бота](../config/bot.config.ts)

## 13. Тест-кейсы (минимум 3)
- Пользователь не состоит в чате — статус external, появляется заглушка
- Пользователь выходит из чата во время работы — роль меняется на external, доступ блокируется
- Пользователь возвращается в чат — роль становится member, доступ восстанавливается 

> Статусы left, active больше не используются для пользователя. Используйте только роли из docs/USER_ROLES.md 